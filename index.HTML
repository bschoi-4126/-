<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>우리집 가계부</title>
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background-color: #f5f5f5; margin: 0; padding: 15px; }
        .container { max_width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* 요약 박스 */
        .summary-box { background: #e3f2fd; padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 20px; }
        .summary-amount { font-size: 24px; font-weight: bold; color: #1976d2; margin: 5px 0; }
        .progress-bar { background: #ddd; height: 10px; border-radius: 5px; margin-top: 10px; overflow: hidden; }
        .progress-fill { background: #1976d2; height: 100%; width: 0%; transition: width 0.5s; }

        /* 입력 폼 */
        input, select { width: 100%; padding: 12px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        
        /* 버튼 그룹 */
        .btn-group { display: flex; gap: 10px; }
        button { flex: 1; padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-submit { background: #2196f3; color: white; }
        .btn-reset { background: #9e9e9e; color: white; }
        .btn-update { background: #4caf50; color: white; display: none; } /* 평소엔 숨김 */

        /* 내역 리스트 */
        .history-list { margin-top: 20px; list-style: none; padding: 0; }
        .history-item { border-bottom: 1px solid #eee; padding: 12px 0; display: flex; justify-content: space-between; align-items: center; }
        .item-left { display: flex; flex-direction: column; width: 60%; }
        .item-right { text-align: right; width: 40%; }
        .item-name { font-weight: bold; font-size: 16px; }
        .item-meta { font-size: 12px; color: #888; margin-top: 4px; }
        .item-amount { font-weight: bold; color: #d32f2f; font-size: 16px; display: block;}
        
        /* 수정/삭제 미니 버튼 */
        .action-btns { margin-top: 5px; }
        .mini-btn { font-size: 12px; padding: 4px 8px; border-radius: 4px; margin-left: 5px; cursor: pointer; border: none; color: white; }
        .btn-edit { background: #4caf50; }
        .btn-del { background: #f44336; }

        .loading { text-align: center; color: #888; margin-top: 10px; display: none; }
        
        /* 수정 모드일 때 입력창 강조 */
        .editing-mode { border: 2px solid #4caf50 !important; background-color: #e8f5e9; }
    </style>
</head>
<body>

<div class="container">
    <h3 style="text-align:center; margin-top:0;">🏠 우리집 가계부</h3>
    
    <div class="summary-box">
        <div style="font-size:14px;">이번 달 남은 돈</div>
        <div class="summary-amount" id="remainingText">계산 중...</div>
        <div class="progress-bar"><div class="progress-fill" id="progressBar"></div></div>
    </div>

    <input type="hidden" id="editRowNumber"> <input type="hidden" id="editOriginalDate"> <select id="category">
        <option value="식비(장보기)">🍎 식비(장보기)</option>
        <option value="외식/배달">🍖 외식/배달</option>
        <option value="생활용품">🧻 생활용품</option>
        <option value="육아/교육">👶 육아/교육</option>
        <option value="교통/차량">🚗 교통/차량</option>
        <option value="의료/건강">💊 의료/건강</option>
        <option value="기타">🎸 기타</option>
    </select>
    <input type="text" id="item" placeholder="내용 (예: 이마트, 스타벅스)">
    <input type="number" id="amount" placeholder="금액 (숫자만)">
    <select id="payer">
        <option value="카드">👨 현대카드</option>
        <option value="현금">💵 현금</option>
		<option value="기타">🎸 기타</option>
    </select>
    
    <div class="btn-group">
        <button class="btn-reset" onclick="resetForm()">초기화</button>
        <button class="btn-submit" id="submitBtn" onclick="submitData()">입력하기</button>
        <button class="btn-update" id="updateBtn" onclick="updateData()">수정완료</button>
    </div>
    
    <div class="loading" id="loadingMsg">처리 중입니다... 잠시만요!</div>

    <h4 style="margin-bottom:10px;">📋 최근 내역</h4>
    <ul class="history-list" id="historyList"></ul>
</div>

<script>
    // https://script.google.com/macros/s/AKfycbxlixbAYlpUyzVwSVEF_aV6ac_7CnVfiueBBNpCuVstRe6UjYpTiARwDhsWvBV2OH_6-w/exec
    var GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxlixbAYlpUyzVwSVEF_aV6ac_7CnVfiueBBNpCuVstRe6UjYpTiARwDhsWvBV2OH_6-w/exec"; 
    var MONTHLY_BUDGET = 2390000;

    // 데이터 로드
    function loadData() {
        fetch(GOOGLE_SCRIPT_URL + "?action=read")
        .then(function(res){ return res.json(); })
        .then(function(data){
            calculateSummary(data);
            renderHistory(data);
        })
        .catch(function(err){
            console.error("로드 실패:", err);
            // alert("데이터 불러오기 실패. URL을 확인해주세요.");
        });
    }

    // 요약 계산
    function calculateSummary(data) {
        var totalUsed = 0;
        var now = new Date();
        var currentMonth = now.getMonth(); 

        for(var i=0; i<data.length; i++) {
            var row = data[i].values; // [날짜, 구분, 내용, 금액, 결제자...]
            var dateStr = row[0];
            var dateObj = new Date(dateStr);
            
            if (dateObj.getMonth() === currentMonth) {
                totalUsed += Number(row[3]);
            }
        }

        var remaining = MONTHLY_BUDGET - totalUsed;
        document.getElementById("remainingText").innerText = remaining.toLocaleString() + "원";
        
        var percent = (totalUsed / MONTHLY_BUDGET) * 100;
        var barWidth = percent > 100 ? 100 : percent;
        document.getElementById("progressBar").style.width = barWidth + "%";
    }

    // 리스트 렌더링
    function renderHistory(data) {
        var list = document.getElementById("historyList");
        list.innerHTML = "";
        
        // 최신순 정렬 (데이터가 많으면 느릴 수 있으니 20개만)
        var reversedData = data.slice().reverse().slice(0, 20);

        for(var i=0; i<reversedData.length; i++) {
            var itemData = reversedData[i];
            var rowNum = itemData.row; // 행 번호
            var vals = itemData.values;
            
            // 날짜 포맷팅 (YYYY-MM-DDT... -> MM/DD)
            var dateObj = new Date(vals[0]);
            var dateStr = (dateObj.getMonth()+1) + "/" + dateObj.getDate();

            var li = document.createElement("li");
            li.className = "history-item";
            li.innerHTML = 
                '<div class="item-left">' +
                    '<span class="item-name">' + vals[2] + '</span>' +
                    '<span class="item-meta">' + dateStr + ' · ' + vals[1] + ' (' + vals[4] + ')</span>' +
                '</div>' +
                '<div class="item-right">' +
                    '<span class="item-amount">-' + Number(vals[3]).toLocaleString() + '</span>' +
                    '<div class="action-btns">' +
                        '<button class="mini-btn btn-edit" onclick="enableEditMode(' + rowNum + ', \'' + escapeHtml(JSON.stringify(vals)) + '\')">수정</button>' +
                        '<button class="mini-btn btn-del" onclick="deleteData(' + rowNum + ')">삭제</button>' +
                    '</div>' +
                '</div>';
            list.appendChild(li);
        }
    }

    // 입력하기
    function submitData() {
        var category = document.getElementById("category").value;
        var item = document.getElementById("item").value;
        var amount = document.getElementById("amount").value;
        var payer = document.getElementById("payer").value;

        if (!item || !amount) { alert("내용과 금액을 입력해주세요!"); return; }

        sendRequest({
            category: category,
            item: item,
            amount: amount,
            payer: payer
        });
    }

    // 수정 모드 활성화
    function enableEditMode(rowNum, valsStr) {
        var vals = JSON.parse(valsStr); // [날짜, 구분, 내용, 금액, 결제자, 비고]
        
        // 폼에 값 채우기
        document.getElementById("editRowNumber").value = rowNum;
        document.getElementById("editOriginalDate").value = vals[0]; // 날짜 유지
        document.getElementById("category").value = vals[1];
        document.getElementById("item").value = vals[2];
        document.getElementById("amount").value = vals[3];
        document.getElementById("payer").value = vals[4];

        // UI 변경 (수정 모드)
        document.getElementById("submitBtn").style.display = "none";
        document.getElementById("updateBtn").style.display = "block";
        
        document.getElementById("item").classList.add("editing-mode");
        document.getElementById("amount").classList.add("editing-mode");
        
        window.scrollTo(0, 0); // 맨 위로 스크롤
        alert("수정할 내용을 입력하고 '수정완료'를 누르세요.");
    }

    // 수정 완료 요청
    function updateData() {
        var rowNum = document.getElementById("editRowNumber").value;
        var originalDate = document.getElementById("editOriginalDate").value;
        
        var category = document.getElementById("category").value;
        var item = document.getElementById("item").value;
        var amount = document.getElementById("amount").value;
        var payer = document.getElementById("payer").value;

        sendRequest({
            action: "update",
            row: rowNum,
            date: originalDate,
            category: category,
            item: item,
            amount: amount,
            payer: payer
        });
    }

    // 삭제 요청
    function deleteData(rowNum) {
        if(confirm("정말 삭제하시겠습니까?")) {
            sendRequest({
                action: "delete",
                row: rowNum
            });
        }
    }

    // 초기화 (Reset)
    function resetForm() {
        document.getElementById("item").value = "";
        document.getElementById("amount").value = "";
        document.getElementById("editRowNumber").value = "";
        
        // UI 원복
        document.getElementById("submitBtn").style.display = "block";
        document.getElementById("updateBtn").style.display = "none";
        document.getElementById("item").classList.remove("editing-mode");
        document.getElementById("amount").classList.remove("editing-mode");
    }

    // 공통 전송 함수
    function sendRequest(params) {
        document.getElementById("loadingMsg").style.display = "block";

        // FormData 만들기
        var formData = new FormData();
        for (var key in params) {
            formData.append(key, params[key]);
        }

        fetch(GOOGLE_SCRIPT_URL, { method: "POST", body: formData })
        .then(function(res){ return res.json(); })
        .then(function(data){
            if(data.result === "success") {
                alert("처리되었습니다! ✅");
                resetForm(); // 폼 초기화
                loadData();  // 목록 갱신
            } else {
                alert("오류 발생: " + data.error);
            }
        })
        .catch(function(err){ alert("통신 오류: " + err); })
        .finally(function(){
            document.getElementById("loadingMsg").style.display = "none";
        });
    }

    // 특수문자 처리 (수정 시 JSON 깨짐 방지)
    function escapeHtml(text) {
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // 시작
    loadData();
</script>

</body>
</html>